<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ecommate COO Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f5f7fa;
            padding: 20px;
        }

        .dashboard-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .dashboard-header h1 {
            font-size: 32px;
            margin-bottom: 8px;
        }

        .dashboard-header p {
            font-size: 16px;
            opacity: 0.9;
        }

        .last-updated {
            font-size: 14px;
            opacity: 0.8;
            margin-top: 10px;
        }

        .sync-status {
            display: inline-block;
            padding: 6px 12px;
            background: rgba(255,255,255,0.2);
            border-radius: 6px;
            font-size: 13px;
            margin-top: 10px;
        }

        .sync-status.syncing {
            background: #fbbf24;
            color: #78350f;
        }

        .sync-status.synced {
            background: #34d399;
            color: #064e3b;
        }

        .sync-status.error {
            background: #f87171;
            color: #7f1d1d;
        }

        .date-filter {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .date-filter label {
            font-weight: 600;
            color: #2d3748;
        }

        .date-filter input[type="date"] {
            padding: 10px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .date-filter input[type="date"]:focus {
            outline: none;
            border-color: #667eea;
        }

        .date-filter button {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .date-filter button:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }

        .date-filter button.reset {
            background: #94a3b8;
        }

        .date-filter button.reset:hover {
            background: #64748b;
        }

        .date-filter-info {
            margin-left: auto;
            color: #64748b;
            font-size: 13px;
            font-weight: 600;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab {
            padding: 12px 24px;
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }

        .tab:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }

        .tab.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .loading-spinner {
            background: white;
            padding: 40px;
            border-radius: 12px;
            text-align: center;
        }

        .spinner {
            border: 4px solid #f3f4f6;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .alert-banner {
            background: #fed7d7;
            border-left: 4px solid #f56565;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
        }

        .alert-banner h2 {
            color: #c53030;
            font-size: 20px;
            margin-bottom: 15px;
        }

        .alert-item {
            background: white;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 10px;
        }

        .alert-item:last-child {
            margin-bottom: 0;
        }

        .alert-item strong {
            color: #c53030;
        }

        .success-banner {
            background: #c6f6d5;
            border-left: 4px solid #48bb78;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            text-align: center;
        }

        .success-banner h2 {
            color: #2f855a;
            font-size: 24px;
        }

        .capacity-card {
            background: #eff6ff;
            border-left: 4px solid #3b82f6;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .capacity-card h3 {
            color: #1e40af;
            font-size: 18px;
            margin-bottom: 15px;
        }

        .capacity-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .capacity-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
        }

        .capacity-label {
            font-size: 12px;
            color: #718096;
            margin-bottom: 5px;
        }

        .capacity-value {
            font-size: 24px;
            font-weight: 700;
            color: #2d3748;
        }

        .capacity-status {
            font-size: 12px;
            margin-top: 5px;
            font-weight: 600;
        }

        .capacity-status.good {
            color: #059669;
        }

        .capacity-status.warning {
            color: #d97706;
        }

        .capacity-status.critical {
            color: #dc2626;
        }

        .team-section {
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .team-section h3 {
            font-size: 18px;
            margin-bottom: 20px;
            color: #2d3748;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            overflow-x: auto;
            display: block;
        }

        thead, tbody {
            display: table;
            width: 100%;
            table-layout: fixed;
        }

        th {
            text-align: left;
            padding: 12px;
            background: #f7fafc;
            font-size: 13px;
            color: #718096;
            font-weight: 600;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid #e2e8f0;
            font-size: 14px;
            word-wrap: break-word;
        }

        tr:last-child td {
            border-bottom: none;
        }

        .person-name {
            font-weight: 600;
            color: #2d3748;
        }

        .status-redflag {
            background: #fee2e2;
            color: #991b1b;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: 600;
            font-size: 12px;
        }

        .status-warning {
            background: #fef3c7;
            color: #92400e;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: 600;
            font-size: 12px;
        }

        .status-good {
            background: #d1fae5;
            color: #065f46;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: 600;
            font-size: 12px;
        }

        .note {
            background: #edf2f7;
            padding: 16px;
            border-radius: 8px;
            font-size: 14px;
            color: #4a5568;
            margin-top: 20px;
        }

        @media (max-width: 768px) {
            .tabs {
                overflow-x: auto;
                flex-wrap: nowrap;
            }

            table {
                font-size: 12px;
            }

            th, td {
                padding: 8px;
            }

            .date-filter {
                flex-direction: column;
                align-items: stretch;
            }

            .date-filter-info {
                margin-left: 0;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="loading-spinner">
            <div class="spinner"></div>
            <p style="color: #4a5568; font-weight: 600;">Loading dashboard data...</p>
        </div>
    </div>

    <div class="dashboard-header">
        <h1>üìä Ecommate COO Dashboard</h1>
        <p>Performance KPIs + Workload Visibility + Capacity Planning</p>
        <div class="last-updated">Last updated: <span id="lastUpdated">Loading...</span></div>
        <div class="sync-status synced" id="syncStatus">
            ‚úì Synced with Google Sheets
        </div>
    </div>

    <div class="date-filter">
        <label for="startDate">üìÖ From:</label>
        <input type="date" id="startDate" />
        
        <label for="endDate">To:</label>
        <input type="date" id="endDate" />
        
        <button onclick="applyDateFilter()">Apply Filter</button>
        <button class="reset" onclick="resetDateFilter()">Show All</button>
        
        <div class="date-filter-info" id="filterInfo">
            Showing all data
        </div>
    </div>

    <div class="tabs">
        <div class="tab active" onclick="showTab('red-flags')">üö® Red Flags</div>
        <div class="tab" onclick="showTab('capacity')">üìä Capacity Planning</div>
        <div class="tab" onclick="showTab('cs')">üìû CS</div>
        <div class="tab" onclick="showTab('disputes')">‚öñÔ∏è Disputes</div>
        <div class="tab" onclick="showTab('creative-strategist')">‚úçÔ∏è Creative Strategist</div>
        <div class="tab" onclick="showTab('video-editors')">üé• Video Editors</div>
        <div class="tab" onclick="showTab('funnel-builders')">üéØ Funnel Builders</div>
        <div class="tab" onclick="showTab('campaign-launcher')">üìß Campaign Launcher</div>
        <div class="tab" onclick="showTab('hr')">üë• HR</div>
    </div>

    <div id="red-flags" class="tab-content active">
        <div id="redFlagsContent"></div>
    </div>

    <div id="capacity" class="tab-content">
        <div id="capacityContent"></div>
    </div>

    <div id="cs" class="tab-content">
        <div id="csContent"></div>
    </div>

    <div id="disputes" class="tab-content">
        <div id="disputesContent"></div>
    </div>

    <div id="creative-strategist" class="tab-content">
        <div id="creativeStrategistContent"></div>
    </div>

    <div id="video-editors" class="tab-content">
        <div id="videoEditorsContent"></div>
    </div>

    <div id="funnel-builders" class="tab-content">
        <div id="funnelBuildersContent"></div>
    </div>

    <div id="campaign-launcher" class="tab-content">
        <div id="campaignLauncherContent"></div>
    </div>

    <div id="hr" class="tab-content">
        <div id="hrContent"></div>
    </div>

    <script>
        const GOOGLE_SHEETS_ID = '1mDLav3tCDpttHdzEmJPdZAy6SXD-01izI9LyzrDSW9Q';
        
        const SHEETS = {
            CS_TEAM: 'CS Team',
            DISPUTES: 'Disputes',
            CREATIVE_STRATEGIST: 'Creative Strategist',
            VIDEO_EDITORS: 'Video Editors',
            CAMPAIGNS: 'Campaigns',
            FUNNELS: 'Funnels',
            HIRING: 'Hiring',
            RED_FLAGS: 'Red Flags'
        };

        let dashboardData = {};
        let startDateFilter = null;
        let endDateFilter = null;
        
        function initializeDateFilter() {
            const today = new Date();
            const lastWeek = new Date();
            lastWeek.setDate(today.getDate() - 7);
            
            document.getElementById('endDate').value = today.toISOString().split('T')[0];
            document.getElementById('startDate').value = lastWeek.toISOString().split('T')[0];
            
            applyDateFilter();
        }
        
        function applyDateFilter() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            if (!startDate || !endDate) {
                alert('Please select both start and end dates');
                return;
            }
            
            if (new Date(startDate) > new Date(endDate)) {
                alert('Start date must be before end date');
                return;
            }
            
            startDateFilter = new Date(startDate);
            endDateFilter = new Date(endDate);
            
            const startFormatted = new Date(startDate).toLocaleDateString();
            const endFormatted = new Date(endDate).toLocaleDateString();
            document.getElementById('filterInfo').textContent = 
                `Showing: ${startFormatted} to ${endFormatted}`;
            
            renderAll();
        }
        
        function resetDateFilter() {
            startDateFilter = null;
            endDateFilter = null;
            
            document.getElementById('filterInfo').textContent = 'Showing all data';
            renderAll();
        }
        
        function renderAll() {
            renderRedFlags();
            renderCapacity();
            renderCS();
            renderDisputes();
            renderCreativeStrategist();
            renderVideoEditors();
            renderFunnelBuilders();
            renderCampaignLauncher();
            renderHR();
        }
        
        function parseDate(dateValue) {
            if (!dateValue) return null;
            
            if (typeof dateValue === 'string' && dateValue.startsWith('Date(')) {
                const match = dateValue.match(/Date\((\d+),(\d+),(\d+)\)/);
                if (match) {
                    const year = parseInt(match[1]);
                    const month = parseInt(match[2]);
                    const day = parseInt(match[3]);
                    return new Date(year, month, day);
                }
            }
            
            if (typeof dateValue === 'number') {
                const excelEpoch = new Date(1899, 11, 30);
                const date = new Date(excelEpoch.getTime() + dateValue * 24 * 60 * 60 * 1000);
                return date;
            }
            
            if (typeof dateValue === 'string') {
                if (dateValue.includes('-')) {
                    return new Date(dateValue);
                }
                
                if (dateValue.includes('/')) {
                    const parts = dateValue.split('/');
                    const month = parseInt(parts[0]) - 1;
                    const day = parseInt(parts[1]);
                    const year = parts[2] ? parseInt(parts[2]) : new Date().getFullYear();
                    const fullYear = year < 100 ? 2000 + year : year;
                    return new Date(fullYear, month, day);
                }
            }
            
            return null;
        }
        
        function formatDisplayDate(dateValue) {
            const date = parseDate(dateValue);
            if (!date || isNaN(date.getTime())) return dateValue || '-';
            
            const month = date.getMonth() + 1;
            const day = date.getDate();
            const year = date.getFullYear();
            
            return `${month}/${day}/${year}`;
        }
        
        function formatDuration(value) {
            if (!value) return '-';
            
            if (typeof value === 'string' && value.includes(':')) {
                return value;
            }
            
            if (typeof value === 'number' && value < 1) {
                const totalSeconds = Math.round(value * 24 * 60 * 60);
                const hours = Math.floor(totalSeconds / 3600);
                const minutes = Math.floor((totalSeconds % 3600) / 60);
                const seconds = totalSeconds % 60;
                
                return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            }
            
            return value;
        }
        
        function filterByDate(data) {
            if (!startDateFilter || !endDateFilter) return data;
            
            return data.filter(row => {
                const rowDate = parseDate(row.Date);
                if (!rowDate || isNaN(rowDate.getTime())) return false;
                
                return rowDate >= startDateFilter && rowDate <= endDateFilter;
            });
        }
        
        function getLatestPerEntity(data, entityKey = 'Name') {
            if (!data || data.length === 0) return [];
            
            const latestMap = new Map();
            
            data.forEach(row => {
                const entity = row[entityKey];
                const date = parseDate(row.Date);
                
                if (!entity || !date) return;
                
                const existing = latestMap.get(entity);
                if (!existing || date > parseDate(existing.Date)) {
                    latestMap.set(entity, row);
                }
            });
            
            return Array.from(latestMap.values());
        }

        async function fetchSheetData(sheetName, range = 'A:Z') {
            const url = `https://docs.google.com/spreadsheets/d/${GOOGLE_SHEETS_ID}/gviz/tq?tqx=out:json&sheet=${sheetName}&range=${range}`;
            
            try {
                const response = await fetch(url);
                const text = await response.text();
                const json = JSON.parse(text.substr(47).slice(0, -2));
                
                const headers = json.table.cols.map(col => col.label || col.id);
                const rows = json.table.rows.map(row => {
                    const obj = {};
                    row.c.forEach((cell, i) => {
                        obj[headers[i]] = cell ? cell.v : null;
                    });
                    return obj;
                });
                
                return rows;
            } catch (error) {
                console.error(`Error fetching ${sheetName}:`, error);
                return [];
            }
        }

        async function loadAllData() {
            showLoading(true);
            updateSyncStatus('syncing', '‚ü≥ Syncing...');
            
            try {
                const [csTeam, disputes, creativeStrategist, videoEditors, campaigns, funnels, hiring, redFlags] = await Promise.all([
                    fetchSheetData(SHEETS.CS_TEAM),
                    fetchSheetData(SHEETS.DISPUTES),
                    fetchSheetData(SHEETS.CREATIVE_STRATEGIST),
                    fetchSheetData(SHEETS.VIDEO_EDITORS),
                    fetchSheetData(SHEETS.CAMPAIGNS),
                    fetchSheetData(SHEETS.FUNNELS),
                    fetchSheetData(SHEETS.HIRING),
                    fetchSheetData(SHEETS.RED_FLAGS)
                ]);
                
                dashboardData = {
                    csTeam,
                    disputes,
                    creativeStrategist,
                    videoEditors,
                    campaigns,
                    funnels,
                    hiring,
                    redFlags
                };
                
                renderAll();
                
                document.getElementById('lastUpdated').textContent = new Date().toLocaleString();
                updateSyncStatus('synced', '‚úì Synced with Google Sheets');
                
                showLoading(false);
            } catch (error) {
                console.error('Error loading data:', error);
                updateSyncStatus('error', '‚úó Sync Error');
                showLoading(false);
            }
        }

        function renderDynamicTable(data, title, icon = 'üìä') {
            if (!data || data.length === 0) {
                return `<p>No data available for ${title}</p>`;
            }
            
            const columns = Object.keys(data[0]).filter(col => col !== 'Date');
            
            let html = `
                <div class="team-section">
                    <h3>${icon} ${title}</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
            `;
            
            columns.forEach(col => {
                html += `<th>${col}</th>`;
            });
            
            html += `
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            data.forEach(row => {
                html += `<tr><td>${formatDisplayDate(row.Date)}</td>`;
                
                columns.forEach(col => {
                    let value = row[col];
                    
                    if (col.toLowerCase().includes('response') || 
                        col.toLowerCase().includes('time') || 
                        col.toLowerCase().includes('duration')) {
                        value = formatDuration(value);
                    }
                    
                    // Highlight Status column
                    if (col === 'Status' || col === 'Flag' || col === 'Alert') {
                        const statusValue = (value || '').toString().toLowerCase();
                        if (statusValue.includes('red') || statusValue.includes('alert') || statusValue.includes('critical')) {
                            value = `<span class="status-redflag">${value}</span>`;
                        } else if (statusValue.includes('warn') || statusValue.includes('watch')) {
                            value = `<span class="status-warning">${value}</span>`;
                        } else if (value) {
                            value = `<span class="status-good">${value}</span>`;
                        }
                    }
                    
                    html += `<td>${value || '-'}</td>`;
                });
                
                html += `</tr>`;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
            
            return html;
        }

        // AUTO-COLLECT red flags from ALL sheets based on Status column
        function collectAllRedFlags() {
            const allRedFlags = [];
            
            // Check all data sources for red flag status
            const dataSources = [
                { data: dashboardData.csTeam, name: 'CS Team', key: 'Name' },
                { data: dashboardData.disputes, name: 'Disputes', key: 'Handler' },
                { data: dashboardData.creativeStrategist, name: 'Creative Strategist', key: 'Name' },
                { data: dashboardData.videoEditors, name: 'Video Editors', key: 'Name' },
                { data: dashboardData.campaigns, name: 'Campaigns', key: 'Campaign' },
                { data: dashboardData.funnels, name: 'Funnels', key: 'Funnel' },
                { data: dashboardData.hiring, name: 'Hiring', key: 'Position' },
                { data: dashboardData.redFlags, name: 'Red Flags Manual', key: 'Title' }
            ];
            
            dataSources.forEach(source => {
                if (!source.data) return;
                
                const filtered = filterByDate(source.data);
                const latest = getLatestPerEntity(filtered, source.key);
                
                latest.forEach(row => {
                    const statusValue = (row.Status || row.Flag || row.Alert || '').toString().toLowerCase();
                    
                    if (statusValue.includes('red') || statusValue.includes('alert') || statusValue.includes('critical')) {
                        allRedFlags.push({
                            source: source.name,
                            entity: row[source.key],
                            date: row.Date,
                            status: row.Status || row.Flag || row.Alert,
                            data: row
                        });
                    }
                });
            });
            
            return allRedFlags;
        }

        function renderRedFlags() {
            const container = document.getElementById('redFlagsContent');
            const flags = collectAllRedFlags();
            
            if (flags.length === 0) {
                container.innerHTML = `
                    <div class="success-banner">
                        <h2>‚úÖ No Red Flags - All Systems Healthy!</h2>
                        <p style="margin-top: 10px; opacity: 0.8;">All KPIs are within acceptable ranges</p>
                    </div>
                `;
                return;
            }
            
            let html = `
                <div class="alert-banner">
                    <h2>‚ö†Ô∏è ${flags.length} Red Flags Detected - Action Required</h2>
                    <p style="margin-top: 10px; opacity: 0.9;">Issues found across ${new Set(flags.map(f => f.source)).size} departments</p>
                </div>
            `;
            
            flags.forEach(flag => {
                html += `
                    <div class="alert-item">
                        <strong>${flag.source} - ${flag.entity}:</strong> ${flag.status}
                        <div style="margin-top: 8px; font-size: 13px; color: #64748b;">
                            Date: ${formatDisplayDate(flag.date)}
                        </div>
                `;
                
                // Show key details from the row
                Object.keys(flag.data).forEach(key => {
                    if (key !== 'Date' && key !== 'Status' && key !== 'Flag' && key !== 'Alert' && flag.data[key]) {
                        html += `<div style="margin-top: 4px; font-size: 13px;"><strong>${key}:</strong> ${flag.data[key]}</div>`;
                    }
                });
                
                html += `</div>`;
            });
            
            container.innerHTML = html;
        }

        function renderCapacity() {
            const container = document.getElementById('capacityContent');
            
            const csTeamRaw = dashboardData.csTeam || [];
            const csTeam = getLatestPerEntity(filterByDate(csTeamRaw), 'Name');
            
            const veRaw = dashboardData.videoEditors || [];
            const ve = getLatestPerEntity(filterByDate(veRaw), 'Name');
            
            const csRaw = dashboardData.creativeStrategist || [];
            const cs = getLatestPerEntity(filterByDate(csRaw), 'Name');
            
            const disputesRaw = dashboardData.disputes || [];
            const disputes = getLatestPerEntity(filterByDate(disputesRaw), 'Handler');
            
            // Calculate capacity metrics
            const csCapacity = calculateTeamCapacity(csTeam, 'Messages');
            const veCapacity = calculateTeamCapacity(ve, 'VideosToday');
            const csCapacityCalc = calculateTeamCapacity(cs, 'ScriptsToday');
            const disputesCapacity = calculateTeamCapacity(disputes, 'ManualToday');
            
            let html = `
                <div class="team-section">
                    <h3>üìä Team Capacity Overview</h3>
                    <p style="margin-bottom: 20px; color: #718096;">
                        Capacity = (Hours Worked Today / 8 hours) √ó 100<br>
                        <strong>100%+</strong> = Overloaded | <strong>80-100%</strong> = Healthy | <strong><80%</strong> = Underloaded
                    </p>
                </div>
            `;
            
            // CS Team Capacity
            if (csTeam.length > 0) {
                html += `
                    <div class="capacity-card">
                        <h3>üìû CS Team Capacity</h3>
                        <div class="capacity-grid">
                            <div class="capacity-item">
                                <div class="capacity-label">Team Size</div>
                                <div class="capacity-value">${csTeam.length}</div>
                            </div>
                            <div class="capacity-item">
                                <div class="capacity-label">Avg Capacity</div>
                                <div class="capacity-value">${csCapacity.avgCapacity}%</div>
                                <div class="capacity-status ${csCapacity.avgCapacity >= 100 ? 'critical' : csCapacity.avgCapacity >= 80 ? 'good' : 'warning'}">
                                    ${csCapacity.avgCapacity >= 100 ? 'üî¥ Overloaded' : csCapacity.avgCapacity >= 80 ? 'üü¢ Healthy' : csCapacity.avgCapacity > 0 ? 'üü° Underloaded' : '‚ö†Ô∏è No data'}
                                </div>
                            </div>
                            <div class="capacity-item">
                                <div class="capacity-label">Avg Hours/Day</div>
                                <div class="capacity-value">${csCapacity.avgHours}</div>
                                <div class="capacity-status ${csCapacity.avgHours >= 8 ? 'critical' : csCapacity.avgHours >= 6.4 ? 'good' : 'warning'}">
                                    ${csCapacity.avgHours >= 8 ? '‚ö†Ô∏è At/Over limit' : csCapacity.avgHours >= 6.4 ? '‚úì Normal' : 'üìâ Low hours'}
                                </div>
                            </div>
                            <div class="capacity-item">
                                <div class="capacity-label">Recommendation</div>
                                <div class="capacity-value" style="font-size: 14px; line-height: 1.4;">
                                    ${csCapacity.recommendation}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Disputes Capacity
            if (disputes.length > 0) {
                html += `
                    <div class="capacity-card">
                        <h3>‚öñÔ∏è Disputes Team Capacity</h3>
                        <div class="capacity-grid">
                            <div class="capacity-item">
                                <div class="capacity-label">Team Size</div>
                                <div class="capacity-value">${disputes.length}</div>
                            </div>
                            <div class="capacity-item">
                                <div class="capacity-label">Avg Capacity</div>
                                <div class="capacity-value">${disputesCapacity.avgCapacity}%</div>
                                <div class="capacity-status ${disputesCapacity.avgCapacity >= 100 ? 'critical' : disputesCapacity.avgCapacity >= 80 ? 'good' : 'warning'}">
                                    ${disputesCapacity.avgCapacity >= 100 ? 'üî¥ Overloaded' : disputesCapacity.avgCapacity >= 80 ? 'üü¢ Healthy' : disputesCapacity.avgCapacity > 0 ? 'üü° Underloaded' : '‚ö†Ô∏è No data'}
                                </div>
                            </div>
                            <div class="capacity-item">
                                <div class="capacity-label">Avg Hours/Day</div>
                                <div class="capacity-value">${disputesCapacity.avgHours}</div>
                                <div class="capacity-status ${disputesCapacity.avgHours >= 8 ? 'critical' : disputesCapacity.avgHours >= 6.4 ? 'good' : 'warning'}">
                                    ${disputesCapacity.avgHours >= 8 ? '‚ö†Ô∏è At/Over limit' : '‚úì Normal'}
                                </div>
                            </div>
                            <div class="capacity-item">
                                <div class="capacity-label">Recommendation</div>
                                <div class="capacity-value" style="font-size: 14px; line-height: 1.4;">
                                    ${disputesCapacity.recommendation}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Video Editors Capacity
            if (ve.length > 0) {
                html += `
                    <div class="capacity-card">
                        <h3>üé• Video Editors Capacity</h3>
                        <div class="capacity-grid">
                            <div class="capacity-item">
                                <div class="capacity-label">Team Size</div>
                                <div class="capacity-value">${ve.length}</div>
                            </div>
                            <div class="capacity-item">
                                <div class="capacity-label">Avg Capacity</div>
                                <div class="capacity-value">${veCapacity.avgCapacity}%</div>
                                <div class="capacity-status ${veCapacity.avgCapacity >= 100 ? 'critical' : veCapacity.avgCapacity >= 80 ? 'good' : 'warning'}">
                                    ${veCapacity.avgCapacity >= 100 ? 'üî¥ Overloaded' : veCapacity.avgCapacity >= 80 ? 'üü¢ Healthy' : veCapacity.avgCapacity > 0 ? 'üü° Underloaded' : '‚ö†Ô∏è No data'}
                                </div>
                            </div>
                            <div class="capacity-item">
                                <div class="capacity-label">Avg Hours/Day</div>
                                <div class="capacity-value">${veCapacity.avgHours}</div>
                                <div class="capacity-status ${veCapacity.avgHours >= 8 ? 'critical' : veCapacity.avgHours >= 6.4 ? 'good' : 'warning'}">
                                    ${veCapacity.avgHours >= 8 ? '‚ö†Ô∏è At/Over limit' : '‚úì Normal'}
                                </div>
                            </div>
                            <div class="capacity-item">
                                <div class="capacity-label">Videos Today</div>
                                <div class="capacity-value">${veCapacity.totalOutput}</div>
                                <div class="capacity-status good">
                                    Avg: ${veCapacity.avgPerPerson}/person
                                </div>
                            </div>
                            <div class="capacity-item">
                                <div class="capacity-label">Recommendation</div>
                                <div class="capacity-value" style="font-size: 14px; line-height: 1.4;">
                                    ${veCapacity.recommendation}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Creative Strategist Capacity
            if (cs.length > 0) {
                html += `
                    <div class="capacity-card">
                        <h3>‚úçÔ∏è Creative Strategist Capacity</h3>
                        <div class="capacity-grid">
                            <div class="capacity-item">
                                <div class="capacity-label">Team Size</div>
                                <div class="capacity-value">${cs.length}</div>
                            </div>
                            <div class="capacity-item">
                                <div class="capacity-label">Avg Capacity</div>
                                <div class="capacity-value">${csCapacityCalc.avgCapacity}%</div>
                                <div class="capacity-status ${csCapacityCalc.avgCapacity >= 100 ? 'critical' : csCapacityCalc.avgCapacity >= 80 ? 'good' : 'warning'}">
                                    ${csCapacityCalc.avgCapacity >= 100 ? 'üî¥ Overloaded' : csCapacityCalc.avgCapacity >= 80 ? 'üü¢ Healthy' : csCapacityCalc.avgCapacity > 0 ? 'üü° Underloaded' : '‚ö†Ô∏è No data'}
                                </div>
                            </div>
                            <div class="capacity-item">
                                <div class="capacity-label">Avg Hours/Day</div>
                                <div class="capacity-value">${csCapacityCalc.avgHours}</div>
                                <div class="capacity-status ${csCapacityCalc.avgHours >= 8 ? 'critical' : csCapacityCalc.avgHours >= 6.4 ? 'good' : 'warning'}">
                                    ${csCapacityCalc.avgHours >= 8 ? '‚ö†Ô∏è At/Over limit' : '‚úì Normal'}
                                </div>
                            </div>
                            <div class="capacity-item">
                                <div class="capacity-label">Scripts Today</div>
                                <div class="capacity-value">${csCapacityCalc.totalOutput}</div>
                                <div class="capacity-status good">
                                    Avg: ${csCapacityCalc.avgPerPerson}/person
                                </div>
                            </div>
                            <div class="capacity-item">
                                <div class="capacity-label">Recommendation</div>
                                <div class="capacity-value" style="font-size: 14px; line-height: 1.4;">
                                    ${csCapacityCalc.recommendation}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }

        function calculateTeamCapacity(team, outputCol) {
            if (!team || team.length === 0) {
                return {
                    avgCapacity: 0,
                    avgHours: 0,
                    totalOutput: 0,
                    avgPerPerson: 0,
                    needsHiring: false,
                    recommendation: 'No data',
                    status: 'unknown'
                };
            }
            
            let totalHours = 0;
            let totalCapacity = 0;
            let totalOutput = 0;
            let peopleWithHours = 0;
            
            team.forEach(person => {
                // Use HoursWorkedToday or HoursToday column
                const hoursWorked = parseFloat(person.HoursWorkedToday || person.HoursToday || 0);
                
                if (hoursWorked > 0) {
                    totalHours += hoursWorked;
                    peopleWithHours++;
                    
                    // Calculate capacity: HoursWorked / 8 hours * 100
                    const capacity = (hoursWorked / 8) * 100;
                    totalCapacity += capacity;
                }
                
                if (person[outputCol]) {
                    totalOutput += parseFloat(person[outputCol]) || 0;
                }
            });
            
            const avgHours = peopleWithHours > 0 ? (totalHours / peopleWithHours).toFixed(1) : 0;
            const avgCapacity = peopleWithHours > 0 ? Math.round(totalCapacity / peopleWithHours) : 0;
            const avgPerPerson = (totalOutput / team.length).toFixed(1);
            
            // Apply user's logic:
            // 100+% = Overloaded
            // 90-100% = Still okay
            // 80-90% = Still okay
            // <80% = Underloaded
            
            let status = 'normal';
            let needsHiring = false;
            let recommendation = '‚úÖ Team capacity is healthy';
            
            if (avgCapacity >= 100) {
                status = 'overloaded';
                needsHiring = true;
                const extraPeople = Math.ceil((avgCapacity - 90) / 100 * team.length);
                recommendation = `üî¥ OVERLOADED - Hire +${extraPeople} ${extraPeople === 1 ? 'person' : 'people'} ASAP`;
            } else if (avgCapacity >= 90) {
                status = 'okay';
                recommendation = 'üü¢ Team capacity is healthy (90-100%)';
            } else if (avgCapacity >= 80) {
                status = 'okay';
                recommendation = 'üü¢ Team capacity is healthy (80-90%)';
            } else if (avgCapacity > 0) {
                status = 'underloaded';
                recommendation = `üü° Team underutilized (${avgCapacity}% capacity)`;
            } else {
                status = 'no-data';
                recommendation = '‚ö†Ô∏è No hours data - Add "HoursWorkedToday" column';
            }
            
            return {
                avgCapacity,
                avgHours: parseFloat(avgHours),
                totalOutput,
                avgPerPerson: parseFloat(avgPerPerson),
                needsHiring,
                recommendation,
                status
            };
        }

        function renderCS() {
            const container = document.getElementById('csContent');
            const csTeamRaw = dashboardData.csTeam || [];
            const csTeamFiltered = filterByDate(csTeamRaw);
            const csTeam = getLatestPerEntity(csTeamFiltered, 'Name');
            
            container.innerHTML = renderDynamicTable(csTeam, 'Customer Service Team', 'üìû');
        }

        function renderDisputes() {
            const container = document.getElementById('disputesContent');
            const disputesRaw = dashboardData.disputes || [];
            const disputesFiltered = filterByDate(disputesRaw);
            const disputes = getLatestPerEntity(disputesFiltered, 'Handler');
            
            container.innerHTML = renderDynamicTable(disputes, 'Dispute Management', '‚öñÔ∏è');
        }

        function renderCreativeStrategist() {
            const container = document.getElementById('creativeStrategistContent');
            const csRaw = dashboardData.creativeStrategist || [];
            const csFiltered = filterByDate(csRaw);
            const cs = getLatestPerEntity(csFiltered, 'Name');
            
            container.innerHTML = renderDynamicTable(cs, 'Creative Strategists', '‚úçÔ∏è');
        }

        function renderVideoEditors() {
            const container = document.getElementById('videoEditorsContent');
            const veRaw = dashboardData.videoEditors || [];
            const veFiltered = filterByDate(veRaw);
            const ve = getLatestPerEntity(veFiltered, 'Name');
            
            container.innerHTML = renderDynamicTable(ve, 'Video Editors', 'üé•');
        }

        function renderFunnelBuilders() {
            const container = document.getElementById('funnelBuildersContent');
            const funnelsRaw = dashboardData.funnels || [];
            const funnels = filterByDate(funnelsRaw);
            
            container.innerHTML = renderDynamicTable(funnels, 'Funnel Builders', 'üéØ');
        }

        function renderCampaignLauncher() {
            const container = document.getElementById('campaignLauncherContent');
            const campaignsRaw = dashboardData.campaigns || [];
            const campaigns = filterByDate(campaignsRaw);
            
            container.innerHTML = renderDynamicTable(campaigns, 'Campaign Launcher', 'üìß');
        }

        function renderHR() {
            const container = document.getElementById('hrContent');
            const hiringRaw = dashboardData.hiring || [];
            const hiringFiltered = filterByDate(hiringRaw);
            const hiring = getLatestPerEntity(hiringFiltered, 'Position');
            
            container.innerHTML = renderDynamicTable(hiring, 'HR & Hiring', 'üë•');
        }

        function showLoading(show) {
            document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
        }

        function updateSyncStatus(status, text) {
            const statusEl = document.getElementById('syncStatus');
            statusEl.className = `sync-status ${status}`;
            statusEl.textContent = text;
        }

        function showTab(tabId) {
            const contents = document.querySelectorAll('.tab-content');
            contents.forEach(content => content.classList.remove('active'));
            
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            document.getElementById(tabId).classList.add('active');
            event.target.classList.add('active');
        }

        setInterval(() => {
            loadAllData();
        }, 5 * 60 * 1000);

        window.addEventListener('DOMContentLoaded', () => {
            initializeDateFilter();
            loadAllData();
        });
    </script>
</body>
</html>
