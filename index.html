<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ecommate COO Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f7fa;
            padding: 20px;
        }

        .dashboard-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .dashboard-header h1 {
            font-size: 32px;
            margin-bottom: 8px;
        }

        .dashboard-header p {
            font-size: 16px;
            opacity: 0.9;
        }

        .filters {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .filter-group label {
            font-weight: 600;
            color: #2d3748;
        }

        .filter-group input,
        .filter-group select {
            padding: 8px 12px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
        }

        .filter-group button {
            padding: 8px 16px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }

        .filter-group button:hover {
            background: #5568d3;
        }

        .filter-info {
            width: 100%;
            padding: 10px;
            background: #edf2f7;
            border-radius: 6px;
            font-size: 14px;
            color: #4a5568;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab {
            padding: 12px 24px;
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }

        .tab:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }

        .tab.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .alert-banner {
            background: #fed7d7;
            border-left: 4px solid #f56565;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-banner h2 {
            color: #c53030;
            font-size: 20px;
            margin-bottom: 15px;
        }

        .alert-item {
            background: white;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 10px;
        }

        .alert-item:last-child {
            margin-bottom: 0;
        }

        .success-banner {
            background: #c6f6d5;
            border-left: 4px solid #48bb78;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }

        .success-banner h2 {
            color: #2f855a;
            font-size: 24px;
        }

        .team-section {
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .team-section h3 {
            font-size: 18px;
            margin-bottom: 20px;
            color: #2d3748;
        }

        .capacity-card {
            background: #f7fafc;
            border-left: 4px solid #4299e1;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .capacity-card h4 {
            color: #2c5282;
            font-size: 16px;
            margin-bottom: 15px;
        }

        .capacity-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .capacity-item {
            background: white;
            padding: 12px;
            border-radius: 6px;
        }

        .capacity-label {
            font-size: 12px;
            color: #718096;
            margin-bottom: 4px;
        }

        .capacity-value {
            font-size: 20px;
            font-weight: 700;
            color: #2d3748;
        }

        .capacity-recommendation {
            padding: 12px;
            background: white;
            border-radius: 6px;
            margin-top: 10px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        th {
            text-align: left;
            padding: 12px;
            background: #f7fafc;
            font-size: 13px;
            color: #718096;
            font-weight: 600;
            border-bottom: 2px solid #e2e8f0;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid #e2e8f0;
            font-size: 14px;
        }

        tr:last-child td {
            border-bottom: none;
        }

        .status-green { color: #48bb78; font-weight: 600; }
        .status-yellow { color: #ecc94b; font-weight: 600; }
        .status-red { color: #f56565; font-weight: 600; }
    </style>
</head>
<body>
    <div class="dashboard-header">
        <h1>üìä Ecommate COO Dashboard</h1>
        <p>Real-time Operations Monitoring ‚Ä¢ Fully Dynamic</p>
    </div>

    <div class="filters">
        <div class="filter-group">
            <label>üìÖ From:</label>
            <input type="date" id="dateFrom">
        </div>
        <div class="filter-group">
            <label>To:</label>
            <input type="date" id="dateTo">
        </div>
        <div class="filter-group">
            <button onclick="applyFilters()">Apply Filter</button>
            <button onclick="showAll()">Show All</button>
        </div>
        <div class="filter-group">
            <label>üè¢ Branch:</label>
            <select id="branchFilter" onchange="applyFilters()">
                <option value="">All Branches</option>
            </select>
        </div>
        <div class="filter-info" id="filterInfo">Showing all data</div>
    </div>

    <div class="tabs">
        <div class="tab active" onclick="showTab('red-flags')">üö® Red Flags</div>
        <div class="tab" onclick="showTab('capacity')">üìä Capacity Planning</div>
        <div class="tab" onclick="showTab('cs')">üìû CS Team</div>
        <div class="tab" onclick="showTab('disputes')">‚öñÔ∏è Disputes</div>
        <div class="tab" onclick="showTab('creative')">‚úçÔ∏è Creative Strategist</div>
        <div class="tab" onclick="showTab('video')">üé¨ Video Editors</div>
        <div class="tab" onclick="showTab('funnel')">üéØ Funnel Builder</div>
        <div class="tab" onclick="showTab('campaign')">üìß Campaign Launcher</div>
        <div class="tab" onclick="showTab('hr')">üë• HR</div>
    </div>

    <div id="red-flags" class="tab-content active"></div>
    <div id="capacity" class="tab-content"></div>
    <div id="cs" class="tab-content"></div>
    <div id="disputes" class="tab-content"></div>
    <div id="creative" class="tab-content"></div>
    <div id="video" class="tab-content"></div>
    <div id="funnel" class="tab-content"></div>
    <div id="campaign" class="tab-content"></div>
    <div id="hr" class="tab-content"></div>

    <script>
        const GOOGLE_SHEETS_ID = '1mDLav3tCDpttHdzEmJPdZAy6SXD-01izI9LyzrDSW9Q';
        const SHEET_NAMES = {
            redFlags: 'Red Flags',
            cs: 'CS Team',
            disputes: 'Disputes',
            creative: 'Creative Strategist',
            video: 'Video Editors',
            funnel: 'Funnels',
            campaign: 'Campaigns',
            hr: 'Hiring'
        };

        let dashboardData = {};
        let currentFilters = { dateFrom: null, dateTo: null, branch: '' };

        // Initialize dates
        function initDates() {
            const today = new Date();
            const weekAgo = new Date(today);
            weekAgo.setDate(weekAgo.getDate() - 7);
            
            document.getElementById('dateFrom').valueAsDate = weekAgo;
            document.getElementById('dateTo').valueAsDate = today;
        }

        // Parse various date formats
        function parseDate(dateStr) {
            if (!dateStr) return null;
            
            // Handle Google Sheets Date format: Date(2025,11,5)
            if (dateStr.toString().includes('Date(')) {
                const match = dateStr.match(/Date\((\d+),(\d+),(\d+)\)/);
                if (match) {
                    return new Date(parseInt(match[1]), parseInt(match[2]), parseInt(match[3]));
                }
            }
            
            // Handle serial number (Excel/Sheets numeric dates)
            if (!isNaN(dateStr) && dateStr > 40000 && dateStr < 60000) {
                return new Date((dateStr - 25569) * 86400 * 1000);
            }
            
            // Try standard parse
            const parsed = new Date(dateStr);
            return isNaN(parsed.getTime()) ? null : parsed;
        }

        // Format date for display
        function formatDate(dateStr) {
            const date = parseDate(dateStr);
            if (!date) return dateStr;
            return `${date.getMonth() + 1}/${date.getDate()}/${date.getFullYear()}`;
        }

        // Format duration
        function formatDuration(value) {
            if (!value) return '';
            
            // If already formatted, return as-is
            if (typeof value === 'string' && value.includes(':')) return value;
            
            // Convert decimal hours to HH:MM:SS
            const hours = Math.floor(value * 24);
            const minutes = Math.floor((value * 24 * 60) % 60);
            const seconds = Math.floor((value * 24 * 60 * 60) % 60);
            
            return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }

        // Filter data
        function filterData(data) {
            if (!data || data.length === 0) return [];
            
            return data.filter(row => {
                // Date filter
                if (currentFilters.dateFrom || currentFilters.dateTo) {
                    const rowDate = parseDate(row.Date || row.date);
                    if (!rowDate) return false;
                    
                    if (currentFilters.dateFrom && rowDate < currentFilters.dateFrom) return false;
                    if (currentFilters.dateTo && rowDate > currentFilters.dateTo) return false;
                }
                
                // Branch filter
                if (currentFilters.branch) {
                    const rowBranch = row.Branch || row.branch || '';
                    if (rowBranch !== currentFilters.branch) return false;
                }
                
                return true;
            });
        }

        // Load data from Google Sheets
        async function loadSheetData(sheetName) {
            try {
                const url = `https://docs.google.com/spreadsheets/d/${GOOGLE_SHEETS_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(sheetName)}`;
                const response = await fetch(url);
                const text = await response.text();
                const json = JSON.parse(text.substr(47).slice(0, -2));
                
                const headers = json.table.cols.map(col => col.label || col.id);
                const data = json.table.rows.map(row => {
                    const obj = {};
                    row.c.forEach((cell, i) => {
                        obj[headers[i]] = cell ? cell.v : '';
                    });
                    return obj;
                });
                
                return data;
            } catch (error) {
                console.error(`Error loading ${sheetName}:`, error);
                return [];
            }
        }

        // Load all data
        async function loadAllData() {
            try {
                dashboardData = {};
                for (const [key, sheetName] of Object.entries(SHEET_NAMES)) {
                    dashboardData[key] = await loadSheetData(sheetName);
                }
                
                updateBranchFilter();
                renderCurrentTab();
                updateFilterInfo();
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }

        // Update branch filter
        function updateBranchFilter() {
            const branches = new Set();
            Object.values(dashboardData).forEach(data => {
                data.forEach(row => {
                    const branch = row.Branch || row.branch;
                    if (branch) branches.add(branch);
                });
            });
            
            const select = document.getElementById('branchFilter');
            const currentValue = select.value;
            select.innerHTML = '<option value="">All Branches</option>';
            Array.from(branches).sort().forEach(branch => {
                const option = document.createElement('option');
                option.value = branch;
                option.textContent = branch;
                select.appendChild(option);
            });
            select.value = currentValue;
        }

        // Apply filters
        function applyFilters() {
            const dateFrom = document.getElementById('dateFrom').value;
            const dateTo = document.getElementById('dateTo').value;
            const branch = document.getElementById('branchFilter').value;
            
            currentFilters = {
                dateFrom: dateFrom ? new Date(dateFrom) : null,
                dateTo: dateTo ? new Date(dateTo) : null,
                branch: branch
            };
            
            renderCurrentTab();
            updateFilterInfo();
        }

        // Show all data
        function showAll() {
            document.getElementById('dateFrom').value = '';
            document.getElementById('dateTo').value = '';
            document.getElementById('branchFilter').value = '';
            currentFilters = { dateFrom: null, dateTo: null, branch: '' };
            renderCurrentTab();
            updateFilterInfo();
        }

        // Update filter info
        function updateFilterInfo() {
            const info = document.getElementById('filterInfo');
            let text = 'Showing: ';
            
            if (currentFilters.dateFrom || currentFilters.dateTo) {
                const from = currentFilters.dateFrom ? formatDate(currentFilters.dateFrom) : 'Start';
                const to = currentFilters.dateTo ? formatDate(currentFilters.dateTo) : 'End';
                text += `${from} to ${to}`;
            } else {
                text += 'All dates';
            }
            
            if (currentFilters.branch) {
                text += ` | Branch: ${currentFilters.branch}`;
            }
            
            info.textContent = text;
        }

        // Render current tab
        function renderCurrentTab() {
            const activeTab = document.querySelector('.tab.active').onclick.toString().match(/'([^']+)'/)[1];
            
            switch(activeTab) {
                case 'red-flags': renderRedFlags(); break;
                case 'capacity': renderCapacity(); break;
                case 'cs': renderCS(); break;
                case 'disputes': renderDisputes(); break;
                case 'creative': renderCreative(); break;
                case 'video': renderVideo(); break;
                case 'funnel': renderFunnel(); break;
                case 'campaign': renderCampaign(); break;
                case 'hr': renderHR(); break;
            }
        }

        // Show tab
        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
            
            event.target.classList.add('active');
            document.getElementById(tabName).style.display = 'block';
            
            renderCurrentTab();
        }

        // Render Red Flags
        function renderRedFlags() {
            const container = document.getElementById('red-flags');
            const data = filterData(dashboardData.redFlags || []);
            
            // Find all rows with "Red Flag", "Alert", or "Critical" in any Status column
            const allFlags = [];
            Object.entries(dashboardData).forEach(([key, sheetData]) => {
                if (key === 'redFlags') return; // Skip red flags sheet itself
                
                const filtered = filterData(sheetData);
                filtered.forEach(row => {
                    Object.entries(row).forEach(([col, value]) => {
                        if (col.toLowerCase().includes('status') && value) {
                            const valStr = value.toString().toLowerCase();
                            if (valStr.includes('red flag') || valStr.includes('alert') || valStr.includes('critical')) {
                                allFlags.push({
                                    sheet: key,
                                    row: row,
                                    status: value
                                });
                            }
                        }
                    });
                });
            });
            
            // Combine manual flags with auto-detected
            const manualFlags = data;
            const totalFlags = manualFlags.length + allFlags.length;
            
            if (totalFlags === 0) {
                container.innerHTML = `
                    <div class="success-banner">
                        <h2>‚úÖ No Red Flags - All Systems Healthy!</h2>
                        <p style="margin-top: 10px; color: #2f855a;">Everything is running smoothly.</p>
                    </div>
                `;
                return;
            }
            
            let html = `
                <div class="alert-banner">
                    <h2>‚ö†Ô∏è ${totalFlags} Red Flag${totalFlags > 1 ? 's' : ''} Detected</h2>
            `;
            
            // Manual flags
            manualFlags.forEach(flag => {
                html += `
                    <div class="alert-item">
                        <strong>${flag.Category || ''} - ${flag.Title || ''}:</strong> ${flag.Description || ''}
                        <div style="margin-top: 8px; font-size: 14px; color: #4a5568;">
                            ${flag.Details || ''}
                        </div>
                    </div>
                `;
            });
            
            // Auto-detected flags
            allFlags.forEach(flag => {
                const name = flag.row.Name || flag.row.name || '';
                const branch = flag.row.Branch || flag.row.branch || '';
                html += `
                    <div class="alert-item">
                        <strong>${flag.sheet} - ${name}${branch ? ' (' + branch + ')' : ''}:</strong> ${flag.status}
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }

        // Render Capacity Planning
        function renderCapacity() {
            const container = document.getElementById('capacity');
            let html = '<div class="team-section"><h3>üìä Team Capacity Overview</h3></div>';
            
            // Calculate capacity for each team
            const teams = [
                { key: 'cs', name: 'CS Team', icon: 'üìû' },
                { key: 'disputes', name: 'Disputes Team', icon: '‚öñÔ∏è' },
                { key: 'creative', name: 'Creative Strategist', icon: '‚úçÔ∏è' },
                { key: 'video', name: 'Video Editors', icon: 'üé¨' }
            ];
            
            teams.forEach(team => {
                const data = filterData(dashboardData[team.key] || []);
                if (data.length === 0) return;
                
                // Calculate team metrics
                let totalHours = 0;
                let totalCapacity = 0;
                let count = 0;
                const individuals = [];
                
                data.forEach(person => {
                    const hours = parseFloat(person['Hours Worked Today'] || person['HoursWorkedToday'] || person['Hours Today'] || person['HoursToday'] || 0);
                    if (hours > 0) {
                        const capacity = (hours / 8) * 100;
                        totalHours += hours;
                        totalCapacity += capacity;
                        count++;
                        
                        individuals.push({
                            name: person.Name || person.name || '',
                            branch: person.Branch || person.branch || '',
                            hours: hours,
                            capacity: capacity
                        });
                    }
                });
                
                if (count === 0) return;
                
                const avgCapacity = totalCapacity / count;
                const avgHours = totalHours / count;
                
                // Determine status
                let status = 'üü¢ Healthy';
                let statusClass = 'status-green';
                let recommendation = '‚úÖ Team capacity is healthy';
                
                if (avgCapacity >= 100) {
                    status = 'üî¥ Overloaded';
                    statusClass = 'status-red';
                    recommendation = `üî¥ OVERLOADED - Consider hiring +${Math.ceil((avgCapacity - 90) / 100 * count)} person(s)`;
                } else if (avgCapacity < 80) {
                    status = 'üü° Underloaded';
                    statusClass = 'status-yellow';
                    recommendation = `üü° Team underutilized (${avgCapacity.toFixed(0)}% capacity)`;
                }
                
                html += `
                    <div class="capacity-card">
                        <h4>${team.icon} ${team.name}</h4>
                        <div class="capacity-summary">
                            <div class="capacity-item">
                                <div class="capacity-label">Team Size</div>
                                <div class="capacity-value">${count}</div>
                            </div>
                            <div class="capacity-item">
                                <div class="capacity-label">Avg Capacity</div>
                                <div class="capacity-value ${statusClass}">${avgCapacity.toFixed(0)}%</div>
                            </div>
                            <div class="capacity-item">
                                <div class="capacity-label">Avg Hours/Day</div>
                                <div class="capacity-value">${avgHours.toFixed(1)}</div>
                            </div>
                            <div class="capacity-item">
                                <div class="capacity-label">Status</div>
                                <div class="capacity-value ${statusClass}">${status}</div>
                            </div>
                        </div>
                        <div class="capacity-recommendation">
                            <strong>Recommendation:</strong> ${recommendation}
                        </div>
                        
                        <div style="margin-top: 20px;">
                            <strong>Individual Capacity:</strong>
                            <table style="margin-top: 10px;">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        ${individuals.some(p => p.branch) ? '<th>Branch</th>' : ''}
                                        <th>Hours Worked</th>
                                        <th>Capacity %</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
                
                individuals.forEach(person => {
                    let personStatus = 'üü¢ Healthy';
                    let personClass = 'status-green';
                    
                    if (person.capacity >= 100) {
                        personStatus = 'üî¥ Overloaded';
                        personClass = 'status-red';
                    } else if (person.capacity < 80) {
                        personStatus = 'üü° Underloaded';
                        personClass = 'status-yellow';
                    }
                    
                    html += `
                        <tr>
                            <td><strong>${person.name}</strong></td>
                            ${individuals.some(p => p.branch) ? `<td>${person.branch || '-'}</td>` : ''}
                            <td>${person.hours.toFixed(1)} hrs</td>
                            <td class="${personClass}">${person.capacity.toFixed(0)}%</td>
                            <td class="${personClass}">${personStatus}</td>
                        </tr>
                    `;
                });
                
                html += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // Generic table renderer
        function renderTable(containerId, data, title) {
            const container = document.getElementById(containerId);
            const filtered = filterData(data);
            
            if (!filtered || filtered.length === 0) {
                container.innerHTML = `
                    <div class="team-section">
                        <h3>${title}</h3>
                        <p style="color: #718096;">No data available for the selected filters.</p>
                    </div>
                `;
                return;
            }
            
            const columns = Object.keys(filtered[0]);
            
            let html = `
                <div class="team-section">
                    <h3>${title}</h3>
                    <table>
                        <thead>
                            <tr>
                                ${columns.map(col => `<th>${col}</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            filtered.forEach(row => {
                html += '<tr>';
                columns.forEach(col => {
                    let value = row[col];
                    
                    // Format dates
                    if (col.toLowerCase() === 'date') {
                        value = formatDate(value);
                    }
                    // Format durations
                    else if (col.toLowerCase().includes('time') || col.toLowerCase().includes('response') || col.toLowerCase().includes('duration')) {
                        value = formatDuration(value);
                    }
                    // Color code status
                    else if (col.toLowerCase().includes('status')) {
                        const valStr = value.toString().toLowerCase();
                        let className = '';
                        if (valStr.includes('red flag') || valStr.includes('overload') || valStr.includes('critical')) {
                            className = 'status-red';
                        } else if (valStr.includes('warning') || valStr.includes('watch') || valStr.includes('yellow')) {
                            className = 'status-yellow';
                        } else if (valStr.includes('good') || valStr.includes('healthy') || valStr.includes('track')) {
                            className = 'status-green';
                        }
                        value = `<span class="${className}">${value}</span>`;
                    }
                    
                    html += `<td>${value || '-'}</td>`;
                });
                html += '</tr>';
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
            
            container.innerHTML = html;
        }

        // Render CS Team
        function renderCS() {
            renderTable('cs', dashboardData.cs || [], 'üìû CS Team');
        }

        // Render Disputes
        function renderDisputes() {
            renderTable('disputes', dashboardData.disputes || [], '‚öñÔ∏è Disputes Team');
        }

        // Render Creative Strategist
        function renderCreative() {
            renderTable('creative', dashboardData.creative || [], '‚úçÔ∏è Creative Strategist');
        }

        // Render Video Editors
        function renderVideo() {
            renderTable('video', dashboardData.video || [], 'üé¨ Video Editors');
        }

        // Render Funnel Builder
        function renderFunnel() {
            renderTable('funnel', dashboardData.funnel || [], 'üéØ Funnel Builder');
        }

        // Render Campaign Launcher
        function renderCampaign() {
            renderTable('campaign', dashboardData.campaign || [], 'üìß Campaign Launcher');
        }

        // Render HR
        function renderHR() {
            renderTable('hr', dashboardData.hr || [], 'üë• HR & Hiring');
        }

        // Initialize
        initDates();
        applyFilters();
        loadAllData();
        
        // Auto-refresh every 5 minutes
        setInterval(loadAllData, 5 * 60 * 1000);
    </script>
</body>
</html>
